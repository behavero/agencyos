# 2026-02-05 Session Notes

## Stats Not Loading (Root Cause Found)

**Problem:** Creators imported successfully (3 creators visible) but all stats showed 0. Console showed "No connected accounts in this agency. Connect the agency admin via OAuth first." for each creator.

**Root Cause:** The stats endpoint (`/api/creators/[id]/stats`) and transaction syncer only looked for tokens in the `models` table. But the agency OAuth token (from "Connect Fanvue") is stored in `agency_fanvue_connections` table. Imported creators don't have personal tokens.

**Fix:**

- `src/app/api/creators/[id]/stats/route.ts` -- Added `import { getAgencyFanvueToken }` and checks `agency_fanvue_connections` first, falls back to `models` table
- `src/lib/services/transaction-syncer.ts` -- Same fix in `getAgencyAdminToken()` function

Commit: `d68b013` - "fix: use agency_fanvue_connections token for stats & transaction sync"

## Live Auto-Refresh System

**Problem:** Stats only updated when user manually clicked "Refresh". Martin wants real-time live data.

**Solution:**

- Created `POST /api/creators/stats/refresh-all` -- bulk endpoint that refreshes all creators in parallel using agency token
- Updated `creator-management-client.tsx`:
  - Auto-refresh on mount if any creator has stats older than 2 minutes
  - Periodic background refresh every 60 seconds
  - "Refresh All" button now uses efficient bulk endpoint

Commit: `2c6b175` - "feat: live stats with auto-refresh and bulk stats API"

## Agent Infrastructure Audit

Reviewed the full agent setup (AGENTS.md, SOUL.md, USER.md, MEMORY.md, TOOLS.md, HEARTBEAT.md, .cursor/rules/, .cursor/agents/). Found:

- USER.md was empty
- MEMORY.md didn't exist
- TOOLS.md was generic template
- HEARTBEAT.md was empty
- .cursor/rules/onyxos.md was outdated (wrong token architecture, stale phase references, leaked secret value)
- .cursor/agents/ had report files mixed with agent definitions
- 30+ stale phase/status markdown files cluttering root

Proceeding with full cleanup and optimization.

## CRITICAL: Stats Wiped to Zero (Feb 6, continued session)

**Problem:** All model stats (revenue_total, subscribers_count, followers_count, posts_count, likes_count) were overwritten with 0. Revenue, subs, followers, posts, likes all zeroed across all 3 creators.

**Root Causes Found (3 separate issues):**

### 1. Stats Refresh writes 0s when API fails

The `/api/creators/stats/refresh-all` endpoint and Creator Management page (60-second auto-refresh) would overwrite model stats with 0 values when Fanvue API calls returned empty/failed data. No protection against writing zeros.

**Fix:** All stats-writing code now only updates fields with non-zero API data:

- `transaction-syncer.ts` `updateModelStats()` - only updates revenue if new total >= existing
- `cron/revenue-heartbeat` - same protection
- `stats/refresh-all` - only writes followers/subs if API call succeeded, only writes revenue if > 0

### 2. Token refresh window too aggressive (killed the connection)

`getAgencyFanvueToken()` used a 1-hour proactive refresh window, but Fanvue tokens last ~1 hour. This meant EVERY call triggered an unnecessary refresh attempt, burning through refresh tokens. The cron used a 2-hour window (same issue).

**Fix:**

- `getAgencyFanvueToken()`: refresh only when < 5 min remaining (was < 1 hour)
- Cron refresh window: 15 minutes (was 2 hours)

### 3. Sync returns "No creators found"

`GET /creators` API returned empty data. The Fanvue API error for individual creators was "Creator not found or not assigned to team member". Connection's `fanvue_user_id` matches Lanaa's UUID. Possible that the account needs specific agency admin role on Fanvue's side.

**Current DB State:**

- Olivia: $475.46 recovered from 481 transactions
- Lexi: $9.99 recovered from 1 transaction
- Lanaa: $0 (had no stored transactions - her $13,153 was from API stats only)
- All subs/followers/posts/likes still at 0 (API calls failing)
- Connection: expired (burned by premature refresh)

**Action Required:** User needs to reconnect Fanvue OAuth. After reconnecting, the new protection should prevent stats from being wiped again.

## Production Hardening (SaaS-Ready)

Martin's directive: This is a SaaS product for all agency owners, not a tool patched around specific models. All fixes must be generic.

**Audit & Fixes Applied:**

### 1. Security: Unprotected debug endpoints

- `db-health/route.ts` and `restore-stats/route.ts` had NO auth. Added `requireAdminAuth`.
- Stack traces were being exposed in error responses across 5 endpoints. Removed all `stack: error.stack` from API responses.

### 2. Data Integrity: 3 additional stats-overwrite-with-0 bugs found

- `cron/daily-refresh` — wrote `subscribers_count: 0`, `followers_count: 0`, `likes_count: 0` when API returned null/undefined counts
- `realtime-sync-service.ts` — same issue with `subscribers_count`
- `stats/refresh-all` personal endpoint path — same issue for all stat fields
- **Fix:** All paths now only write non-zero values. Never overwrite existing data with 0.

### 3. Sync Logic Cleaned Up

- Removed `(isConnectedUser || true)` debug shortcut that was wasting API calls trying personal endpoint for non-connected creators
- Personal endpoint now only called for the connected user (the one whose account is linked via OAuth)
- All logic is dynamic: compares `model.fanvue_user_uuid === connection.fanvue_user_id` at runtime

### 4. Code Audit Confirmed

- No hardcoded model names, agency IDs, or UUIDs in source code
- All sync logic is generic — works for any agency connecting any Fanvue account
- `isConnectedUser` detection is a valid generic pattern for any agency admin who is also a creator

Commit: `9e8c0be` - "harden: production-ready security and data integrity"

## Phase 4: Production Polish (Completed)

### 4.1 Backend Optimizations

- **Chat count**: Replaced O(n) full chat pagination (up to 100 pages) with single-page count + DB fallback in `creators/[id]/stats/route.ts`
- **Golden Ratio**: Replaced client-side filtering (limited to 10k rows) with parallel SQL SUM queries in `analytics-engine.ts`
- **Subscriber History + Top Spenders cron**: Added both syncs to `revenue-heartbeat` cron (7-day rolling + top 50 spenders per agency)

### 4.2 Database Indexes

- Created `20260206_add_performance_indexes.sql` with 7 composite indexes for:
  - `fanvue_transactions(agency_id, transaction_date)` — analytics/charts
  - `fanvue_transactions(model_id, transaction_type, fan_id)` — derived counts
  - `fanvue_transactions(agency_id, transaction_type, transaction_date)` — golden ratio
  - `tracking_links(agency_id, total_revenue)` — top links sort
  - `subscriber_history(model_id, date)` — audience growth
  - `models(agency_id, fanvue_user_uuid)` — refresh-all
  - `agency_fanvue_connections(status, token_expires_at)` — cron refresh

### 4.3 API Call Optimization

- Created `src/lib/fanvue/response-cache.ts` — in-memory TTL cache (60s, 500 entries max) with `withCache()` helper
- Added token caching in `getAgencyFanvueToken()` to avoid DB reads on concurrent dashboard requests

### 4.4 Frontend Polish

- Created `CardErrorBoundary` component — catches rendering errors per-tab instead of crashing whole page
- Created `StatCardSkeleton`, `ChartCardSkeleton`, `ListCardSkeleton`, `DashboardStatsSkeleton` — shimmer loading states
- Wrapped all 3 dashboard tabs (Overview, Fanvue & Finance, Social) with error boundaries
- Added loading skeleton grid during initial dashboard load
- Deleted unused `floating-chat.tsx.disabled` file

### 4.5 2FA (TOTP) Implementation

- API: `GET/POST/DELETE /api/user/mfa` — list/enroll/unenroll TOTP factors via Supabase Auth MFA
- API: `POST /api/user/mfa/verify` — challenge+verify flow for enrollment completion
- UI: Full 2FA card in Settings page with QR code display, manual secret, 6-digit verification, enable/disable flow
