Worked on `/dashboard/messages` crash. Identified React minified error #185 as max update depth loop caused by `useChatStore()` object in `MessagesClient` effect. Updated to use Zustand selectors and stable `setSelectedConversation`, plus `optimisticMessages` selector.
Commented out `setSelectedConversation` effect in `MessagesClient` to fully break the loop; committed and pushed.
`curl -v https://onyxos.vercel.app/api/analytics/dashboard` returned `401 Unauthorized` (missing keys on Vercel).

## Phase E — Polish & Hardening (deployed)

Completed and deployed to production (commit `4332c12`):

- **Env validation**: `src/lib/utils/env-validation.ts` — logs errors/warnings at Node.js startup via `instrumentation.ts`
- **Debug route auth**: `src/lib/utils/debug-auth.ts` + applied to all 8 `/api/debug/*` routes — requires admin/owner/grandmaster role in production, allows dev access + CRON_SECRET
- **ESLint**: Upgraded `eslint-config-next` to v15 (v16 requires ESLint 9 flat config, not worth migrating yet)
- **react-is**: Added missing dependency needed by recharts
- **Alfred AI chat**: Re-enabled `AlfredFloatingChat` component (AI SDK v6 `@ai-sdk/react` useChat) + new `/api/chat` streaming route using Groq Llama 3.3 70B. Key lesson: AI SDK v6 useChat has no `input`/`handleInputChange`/`handleSubmit`/`setInput`/`isLoading`/`reload` — manage input state locally, use `sendMessage({ text })`, derive loading from `status`, use `regenerate()`.
- Build passed, pushed, Vercel deployment ready (58s build).

## Post-Deploy Fixes (5 issues)

Deployed commit `0618586`:

1. **CI**: Added `.npmrc` with `legacy-peer-deps=true` — `npm ci` was failing in GitHub Actions due to peer dep conflicts
2. **Agency OAuth redirect**: Changed ALL redirect targets from `/dashboard/agency-settings` to `/dashboard/creator-management` in both `login/route.ts` and `callback/route.ts`
3. **Alfred chat**: Added `convertToModelMessages(uiMessages)` in `/api/chat/route.ts` — useChat sends UIMessage[] (parts-based) but streamText expects ModelMessage[] (content-based). Must `await` it (returns Promise).
4. **Duplicate UI**: Removed `<Sidebar />` + `<Header />` + layout wrapper from 11 dashboard page files — `layout.tsx` already provides these, causing double rendering on CRM, Quests, Content, Team, etc.
5. **Ghost Tracker**: Improved scan error message to show "FIRECRAWL_API_KEY not configured" instead of generic "Initial scan failed". Need to add FIRECRAWL_API_KEY to Vercel env vars for the feature to work.

### Key lesson: AI SDK v6 message format

- Client `useChat` sends `UIMessage[]` with `parts: [{ type: 'text', text: '...' }]`
- Server `streamText` expects `ModelMessage[]` with `role`/`content`
- Bridge: `await convertToModelMessages(uiMessages)` from `'ai'` package
